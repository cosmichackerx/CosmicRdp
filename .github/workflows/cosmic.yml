name: AvicaRDP

on:
  workflow_dispatch:

jobs:
  avica_rdp:
    runs-on: windows-latest
    timeout-minutes: 350

    steps:
      - name: Download and setup
        run: |
          Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/setup.py" -OutFile "setup.py"
          Invoke-WebRequest -Uri "https://download.avica.com/AvicaLite_v8.0.8.9.exe" -OutFile "Avica_setup.exe"
          Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/show.bat" -OutFile "show.bat"
          Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/loop.bat" -OutFile "loop.bat"
          python -m pip install --quiet requests pyautogui telegraph
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          net user runneradmin TheDisa1a
          Write-Host "Launching Avica setup..."
          Start-Process ".\Avica_setup.exe"
          Start-Sleep -Seconds 20
          python setup.py

      - name: Show connection info
        run: |
          Write-Host "╔══════════════════════════════════════╗"
          Write-Host "║        AVICA RDP CONNECTION          ║"
          Write-Host "╚══════════════════════════════════════╝"
          Write-Host ""
          Write-Host "GoFile link will appear above if setup.py ran successfully."
          Write-Host "If not: check previous logs for errors."

      - name: Wait for user to connect, then exit
        run: |
          Write-Host "Waiting 2 minutes for you to copy the GoFile link and connect..."
          Start-Sleep -Seconds 120
