name: CosmicRdp
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Auto-restart every 6 hours

jobs:
  build:
    name: CosmicRDP Setup
    runs-on: windows-latest
    timeout-minutes: 350  # Extended timeout for setup

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Configure System
        run: |
          Write-Host "🔧 Configuring system for CosmicRDP..." -ForegroundColor Blue

          # Enable RDP securely
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          # Set a secure password (replace with GitHub Secrets in production)
          $password = ConvertTo-SecureString "${{ secrets.RDP_PASSWORD }}" -AsPlainText -Force
          New-LocalUser -Name "CosmicUser" -Password $password -FullName "CosmicRDP User" -Description "Temporary RDP User"
          Add-LocalGroupMember -Group "Administrators" -Member "CosmicUser"

          Write-Host "✅ System configured!" -ForegroundColor Green

      - name: Install Required Software
        run: |
          Write-Host "📦 Installing software..." -ForegroundColor Blue

          # Install Chocolatey (if not already installed)
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

          # Install tools via Chocolatey
          choco install python -y
          choco install git -y
          choco install vscode -y  # Optional: For debugging

          # Install Python packages
          python -m pip install requests pywin32 --quiet

          Write-Host "✅ Software installed!" -ForegroundColor Green

      - name: Launch CosmicRDP Service
        run: |
          Write-Host "🚀 Starting CosmicRDP service..." -ForegroundColor Yellow

          # Start a custom RDP service (replace with your logic)
          Start-Process -FilePath "python" -ArgumentList "-m http.server 8080" -WindowStyle Hidden

          Write-Host "🌐 Service running at: http://localhost:8080" -ForegroundColor Cyan

      - name: Display Connection Info
        run: |
          Write-Host "
          ╔══════════════════════════════════════╗
          ║        COSMIC RDP CONNECTION         ║  
          ╚══════════════════════════════════════╝

          🔒 Credentials:
          Username: CosmicUser
          Password: ${{ secrets.RDP_PASSWORD }}

          🌐 Connect via:
          - IP: $(Invoke-RestMethod -Uri "https://api.ipify.org?format=json").ip
          - Port: 3389 (RDP)

          ⚠️ Note:
          - This is a temporary session.
          - Change the password immediately after login.
          " -ForegroundColor Cyan

      - name: Keep Session Alive
        run: |
          Write-Host "⏳ Keeping session active..." -ForegroundColor Yellow
          while ($true) {
              Start-Sleep -Seconds 300  # Prevent timeout
              Write-Host "Session active as of $(Get-Date)" -ForegroundColor DarkGray
          }
